---
{"dg-publish":true,"permalink":"/Code/3.ComputerNetwork/CN.0a.应用层/","title":"应用层","noteIcon":""}
---


# 应用层

网络应用程序仅运行在端系统上，不涉及[[ComputerNetwork.0.计算机网络#^internetCore\|网络核心]]

**应用程序体系结构** (application architecture)：
- 客户-服务器(C/S)
	- 服务器存储资源，客户端仅向服务器请求资源，
	- 服务器持续运行，具有固定的IP地址和周知的端口号
	- 可扩展性差
- 对等模式P2P(peer-to-peer)
	- 任意端系统都能相互通信
	- 自扩展性(self-scalability)
	- 管理困难
- 混合模式
	- 客户端登录时向服务器注册
	- 端系统相互通信

## 应用层通信原理

网络应用依赖于进程端口的相互通信，在同一个主机内使用进程间通信机制通信，在不同主机上通过交换报文来通信
- 进程：在主机上运行的应用程序
- 客户端进程：发起通信的进程
- 服务器进程：等待通信的进程
- P2P中也存在客户端进程和服务器进程

应用层通过IP地址和端口号确定传输双方的身份
每个主机具有唯一的一个32位的IP地址
每个进程具有一个**端口号**(port number)，流行的应用协议分配有特定的端口号
TCP、UDP 分别实现了端口，因此两个协议的端口不会互相影响。

**应用层协议**规定了不同端系统上的应用进程如何相互交换报文
- 交换的报文类型，例如请求报文和响应报文。
- 各种报文类型的语法，如报文中的各个字段及这些字段是如何描述的。
- 字段的语义，即这些字段中的信息的含义。
- 确定一个进程何时以及如何发送报文，对报文进行响应的规则。

## 应用层相关协议

### HTTP协议

[[Code/3.ComputerNetwork/CN.0a1.HTTP协议#HTTP 基础知识\|CN.0a1.HTTP协议#HTTP 基础知识]]

同时HTTP通过代理服务器减轻网络负载
[[Code/3.ComputerNetwork/CN.0a1.HTTP协议#代理/缓存\|CN.0a1.HTTP协议#代理/缓存]]

### DNS

**域名系统 DNS**(Domain Name System)提供映射到其他域名或者 IP，或者 IP 映射到域名的功能

DNS是：
- 一个由分层的DNS服务器(DNS server) 实现的分布式数据库
- 一个主机用于查询分布式数据库的应用层协议

DNS功能：
- 主机名-IP 地址的转换
- 主机别名(host aliasing) - 规范主机名(canonical hostname) 的转换
  - 有着复杂主机名的主机拥有一个或者多个别名
- 邮件服务器别名-规范主机名的转换
- 负载分配(load distribution)
  - 繁忙站点被冗余分布在多台服务器上，其规范主机名连接着一个IP地址集合

>[!note] 域名
>主机域名往往采用层次树状结构的命名方法，域名命名从本域往上，直到树根，中间使用“.”间隔不同的级别
>例如：`ustc.edu.cn`、`auto.ustc.edu.cn`、`www.auto.ustc.edu.cn`
>Internet 根被划为几百个顶级域(top lever domains)，每个(子)域下面可划分为若干子域(subdomains)，每个域管理自己的子域
>
>域的域名：可以用于表示一个域
>主机的域名：一个域上的一个主机

DNS 服务器结构：
1. 根 DNS 服务器
  - 提供顶级域服务器的 IP 地址
2. 顶级域(Top-Level Domain, TLD) DNS 服务器
  - 负责通用顶级域名(如 com, org, net,edu 和 gov)或国家顶级域名(如 cn，uk，fr，ca，jp ) ，管理注册在该顶级域名下的所有二级域名
  - 提供权威 DNS 服务器的 IP 地址
3. 权威 DNS 服务器
  - 组织机构的 DNS 服务器，提供组织机构服务器(如 Web 和 mail)可访问的主机和 IP 之间的映射
4. 本地 DNS 服务器(Local DNS Server)
  - 严格来说不属于DNS系统的层次结构
  - 每个ISP都有一台本地DNS服务器

#### 域名解析

DNS 查询方式分为**递归查询**和**迭代查询**两种：

![|375](https://image.jiang849725768.asia/2022/202212081811082.png)
递归查询下本地 DNS 服务器向根 DNS 服务器发送请求后，根服务器向下发送查询请求，然后将结果返回给本地 DNS 服务器

缺点：根节点负担重

![|325](https://image.jiang849725768.asia/2022/202212081814132.png)
迭代查询下域名服务器向本地 DNS 服务器返回下一步应访问的 DNS 服务器，本地 DNS 服务器迭代访问直到返回最终 IP 地址

#### 具体流程

> [DNS面试也会问，赶紧来看看 - 掘金 (juejin.cn)](https://juejin.cn/post/7035659937166393375#heading-13)

1. 浏览器将会检查缓存中有没有这个域名对应的解析过的 IP 地址，如果有该解析过程将会结束
2. 如果用户的浏览器中缓存中没有，操作系统会先检查自己本地的 DNS 解析器缓存和 hosts 文件是否有这个网址映射关系，如果有，就先调用这个 IP 地址映射，完成域名解析
3. 如果都没有，会找 TCP/IP 参数中设置的首选 DNS 服务器 - 本地 DNS 服务器。通过递归查询的方式向本地 DNS 服务器发起查询，如果本地 DNS 服务器中有 A 记录或者该域名的映射缓存，则返回
4. 如果都没有，本地域名服务器会开始迭代查询的过程，
    1. 先向 13 台根域名服务器查询该域名，根域名服务器会返回该域名的顶级域名服务器的 IP 地址，也就是 NS 记录
    2. 然后本地域名服务器再向顶级域名服务器发起查询，顶级域名服务器返回二级域名服务器的 NS 记录
    3. 重复这个过程直到返回 A 记录为止，最后把 A 记录中的 IP 地址返回给主机

####  DNS 缓存

在一个请求链中，当某 DNS 服务器接收到一个 DNS 回答(例如某主机名到 IP 地址的映射)时将映射缓存在本地存储器中，并在一定时间后丢弃，通过缓存可减少对根节点的请求

DNS服务器将主机名到IP地址的映射关系以**资源记录**(Resource Record，RR)的形式进行存储
每条记录都包含`(Domain_Name, TTL, Type, Class, Value)`
- Domain_name: 域名
- TTL: time to live, 生存时间
- Class 类别：对于Internet，值为IN(可维护非Internet值)
- Value 值：可以是数字，域名或ASCII串
- Type 类别：资源记录的类型

解析记录存储在域名服务器中，用于表达域名与 IP 之间的对应关系，根据使用场景记录可以分成不同的类型
| type  | 解释                                                                                                  |
|:-----:| ----------------------------------------------------------------------------------------------------- |
|   A   | 地址记录(Address),返回域名指向的IPv4地址                                                              |
| AAAA  | AAAA记录(AAAA record),返回域名指向的IPv6地址                                                          |
|  NS   | 域名服务器记录(Name Server),返回保存下一级域名信息的服务器地址。该记录只能设置为域名,不能设置为IP地址 |
| CNAME | 规范名称记录(Canonical Name),返回另一个域名,即当前查询的域名是另一个域名的跳转                        |
|  MX   | 邮件记录(Mail eXchange),返回接收电子邮件的服务器地址                                                  |

DNS协议：查询和响应报文的报文格式相同
报文首部包含12个字节，又分为六个字段，第一个字段为报文标识符(id)，第二个字段为标志，包含对报文类型的各种标志，如1bit的“查询/回答”标志位指出报文是查询报文(0)还是回答报文(1)

#### 底层协议

DNS 同时使用 TCP 和 UDP 协议的 53 号端口，**大部分情况下使用 UDP 协议**，在区域传输 (同步解析记录)和 DNS 响应大于 UDP 报文最大长度(512 byte)的时候使用 TCP 协议

原因：
- 所需传输内容少
- UDP 传输速度快

#### 网络攻击

- **域名屏蔽** - 对域名直接不解析，返回错误，让客户端无法拿到 IP 地址，也就无法访问网站
- **域名劫持** - 也叫域名污染，要访问 A 网站，但 DNS 返回 B 网站

### FTP

[深入理解FTP协议 - luoxn28 - 博客园 (cnblogs.com)](https://www.cnblogs.com/luoxn28/p/5585458.html)

**文件传输协议**(File Transfer Protocol，FTP)是一个用于在计算机网络上在客户端和服务器之间进行文件传输的应用层协议
默认控制端口号为21，传输端口号为20

FTP 用于向远程主机上传输文件或从远程主机接收文件，使用 C/S 结构

与 HTTP 相比，FTP 维护用户状态，同时**控制与数据传输采用不同的连接**，通过控制连接发送命令及响应，使用数据传输连接来传输文件
在控制连接上以*ASCII 文本*方式传送命令及响应

目前 FTP 协议在主流浏览器中基本被弃用

#### 数据表示

FTP 协议规定了控制协议传送与存储的多种选择
- 文件类型：ASCII码文件(默认)/ 图像文件类型(二进制)/ 本地文件类型(用于在具有不同字节大小主机间传送二进制数据)
- 格式控制：该选项针对ASCII类型文件适用，非打印(默认选择，文件中不包含垂直格式信息)/ 远程登录格式控制
- 结构：文件结构(默认，文件被认为是一个连续的字节流，不存在内部的文件结构)/ 记录结构(用于文本文件)
- 传输方式：流方式(默认)/ 块方式(文件以一系列块来传送，每块前面有一个或多个首部字节)/ 压缩方式

默认流传输方式下文件以字节流方式传输，对于文件结构，发方在文件尾提示关闭数据连接，对于记录结构，有专用的两字节序列码记录结束和文件结束

#### 连接建立方式

> [浅谈FTP协议的工作方式 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/34109504)

主动方式 - PORT 方式 - 在建立数据连接的过程中，由服务器主动发起连接，因此被称为主动方式
1. FTP 客户端向 FTP 服务器发送 PORT 命令，告诉服务器该客户端用于传输数据的临时端口号
2. 当需要传送数据时，服务器通过 TCP 端口号20与客户端的临时端口建立数据传输通道，完成数据传输

被动方式 - PASV 方式 - 在整个过程中，由于服务器总是被动接收客户端的数据连接，因此被称为被动方式
1. FTP 客户端通过向 FTP 服务器发送 PASV 命令，告诉服务器进入被动方式
2. 服务器选择临时端口号并告知客户端
3. 当需要传送数据时，客户端主动与服务器的临时端口号建立数据传输通道，完成数据传输

当 FTP 服务器与 FTP 客户端均处于同一局域网内，即两者之间互访不存在防火墙或其他安全设备时，主动方式、被动方式均可实现 FTP 文件分发共享
如果 FTP 服务器处于路由器，防火墙或其他 NAT 设备之后，建议使用被动模式，因为在主动模式下传输数据时，由 FTP 发起的数据传输一般会被客户端网关的防火墙阻断

### SMTP

互联网电子邮件系统由**用户代理**(user agent)、**邮件服务器**(mail server) 和**简单邮件传输协议**(Simple Mail Transfer Protocol, **SMTP**)三部分组成
SMTP使用客户-服务器结构，默认端口为25，报文必须为7位ASCII码

用户代理为Outlook、Gmail等邮件处理应用
每个用户在邮件服务器上有一个邮箱，邮箱管理和维护发送给该用户的邮件

邮件：发送方用户代理->发送方服务器->报文队列->SMTP握手->基于SMTP发送email报文->接收方服务器->接收方邮箱->POP3/IMAP/HTTP->接收方用户代理

**POP**：邮局访问协议(Post Office Protocol)
- 无状态
- 用户将邮件下载至本地管理
**IMAP**：Internet邮件访问协议(Internet Mail Access Protocol)
- 会话过程中保留用户状态
- 将报文与文件夹关联，用户远程管理文件夹

发送失败：发送方用户代理->发送方服务器->报文队列->发送失败->间隔一段时间再次发送->多次失败->服务器删除报文并以email通知发送方

SMTP与HTTP的区别：
- HTTP为拉协议(pull protocol)，客户端向服务器请求拉取文件，SMTP为推协议(push protocol)
- HTTP报文不受ASCII码限制
- HTTP把每个对象封装到对象自身的HTTP响应报文中，SMTP则把所有报文对象放在一个报文之中

邮件报文格式：
![|525](https://image.jiang849725768.asia/2022/202212072023591.png)

**多媒体邮件扩展MIME**(multimedia mail extension)用于报文扩展，使用指定编码方式将非ASCII码内容编码为ASCII码发送

### URI

**URI**(Uniform Resource Identifier，统一资源定位标识符) 用字符串标识某一互联网资源，而 URL 表示资源的地点(互联网上所处的位置)，后者是前者的子集
表示指定的 URI，要使用涵盖全部必要信息的绝对 URI、绝对 URL 以及相对 URL

`http://user:pass@www.example.jp:80/dir/index.htm?uid=1#ch1` 为**绝对 URI**，不区分大小写
- `http` 或 `https` 为协议方案名
- `user:pass` 为登录信息(可选项)
	指定用户名和密码作为从服务器端获取资源时必要的登录信息
- `www.example.jp` 为服务器地址
	类似这种 DNS 可解析的名称，或是 192.168.1.1 这类 IPv4 地址名，还可以是\[0:0:0:0:0:0:0:1\] 这样用方括号括起来的 IPv6 地址名
- `80` 为服务器端口号(可选项)
	省略则自动使用默认端口号
- `/dir/index.htm` 为带层次的文件路径
	指定服务器上的文件路径来定位特指的资源
- `uid=1` 为查询字符串(可选项)
- `ch1` 为片段标识符(可选项)

相对 URL 与带层次的文件路径类似

用来制定 HTTP 协议技术标准的文档被称为**RFC**(征求修正意见书)

## Web 构建

Web 页由 HTML 文件，JPEG 图像等多种对象组成，其含有一个基本的 HTML 文件，该文件中包含对其他对象的引用(链接)

### HTML

**HTML**(HyperText Markup Language，超文本标记语言)是为了发送 Web 上的**超文本**(Hypertext)而开发的标记语言。
超文本是一种文档系统，可将文档中任意位置的信息与其他信息(文本或图片等)建立关联，即超链接文本。
标记语言是指通过在文档的某部分穿插特别的字符串标签，用来修饰文档的语言。
我们把出现在 HTML 文档内的这种特殊字符串叫做 **HTML 标签**(Tag)

示例;
```html
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>hackr.jp</title>
<style type="text/css">
.logo {
padding: 20px;
text-align: center;
}
</style>
</head>
<body>
<div class="logo">
<p><img src="photo.jpg" alt="photo" width="240" height="127" /></p>
<p><img src="hackr.gif" alt="hackr.jp" width="240" height="84" /></p>
<p><a href="http://hackr.jp/">hackr.jp</a> </p>
</div>
</body>
</html>
```

HTML5 是 HTML 最新的修订版本，广义论及 HTML5 时，实际指的是包括 HTML、CSS 和 JavaScript 在内的一套技术组合。

#### 动态 HTML

**动态 HTML**(Dynamic HTML)是通过调用客户端脚本语言**JavaScript**将静态的 HTML 内容变成动态的技术的总称
利用 **DOM**(Document ObjectModel，文档对象模型)可指定欲发生动态变化的 HTML 元素

### XML

**XML**(eXtensible Markup Language，可扩展标记语言)是一种可按应用目标进行扩展的通用标记语言
XML 和 HTML 都是从标准通用标记语言 **SGML**(Standard GeneralizedMarkup Language)简化而成，与 HTML 相比，它对数据的记录方式做了特殊处理

### JSON

**JSON**(JavaScript Object Notation)是一种以 JavaScript(ECMAScript)的对象表示法为基础的轻量级数据标记语言。能够处理的数据类型有 *布尔值/空值/对象/数组/数字/字符串*，这 7 种类型。

### CSS

**CSS**(Cascading Style Sheets，层叠样式表)可用于指定 HTML 和 XML 内的各种元素的样式。
示例：
```css
.logo {
padding: 20px;
text-align: center;
}
```

### WEB 应用

由程序创建的 HTML 内容称为*动态内容*，而事先准备好的 HTML 内容称为*静态内容*

**CGI**(Common Gateway Interface，通用网关接口)是为提供网络服务而执行控制台应用 (或称命令行界面)的程序。在 CGI 的作用下，程序会对请求内容做出相应的动作，比如创建动态内容。

**Servlet** 是一种能在服务器上创建动态内容的程序，解决了 CGI 创建程序带来的服务器负担
Servlet 是用 Java 语言实现的一个接口，属于面向企业级 Java 的一部分

## P2P

纯P2P架构：
- 基本没有一直运行的服务器
- 任意端系统可以直接通信
- peer节点每次连接的IP地址可能变化

非结构化P2P：节点间随机连接
- 集中式目录，中心服务器管理资源关系
- 完全分布式：泛洪式查询，e.g. Gnutella
- 混合式：对等方连接组长，组长相互连接并管理资源关系，e.g. KaZaA
DHT(Distributed Hash Table)P2P(结构化)：节点间有序连接

通常使用Hash值作为文件的唯一标识

### BitTorrent

BitTorrent是一种用于文件分发的流行P2P协议

参与一个特定文件分发的所有对等方(peer)的集合被称为一个**洪流**(torrent) ，每个洪流具有一个基础设施节点**追踪器**(tracker) ，在一个洪流中的对等方彼此下载等长度的文件块(chunk)(通常大小为256KB)，一个对等方拥有块的情况由BitMap描述

当一个对等方X加入某洪流时
1. 它向追踪器注册自己并周期性地通知追踪器它仍在该洪流中
2. 追踪器随机地从参与对等方的集合中选择一个子集并将其中对等方的IP地址列表发送给X
3. X尝试与列表中的所有对等方建立并行的TCP连接，成功建立连接的对等方称为**邻近对等方**
4. X周期性询问每个邻近对等方所具有的块列表，并对其当前没有的块发出请求
5. 随时间流逝对等方可能会上线或者下线，邻近对等方会发生变化

请求块算法：**最稀缺优先**(rarest first)
针对当前没有的块在邻近对等方集合中的副本数量决定最稀缺的块，并首先请求那些最稀缺的块
发送块算法：**一报还一报**(tit-for-tat)
对每个邻近对等方实时监测块接收速率，向接收块速率最快的 4 个对等方优先发送块，同时每过 30 秒随机选择一个邻近对等方发送块

## CDN

### 互联网视频

视频流量占据着互联网大部分的带宽
视频是以一种恒定速率展现的图像，一幅未压缩、数字编码的图像由像素阵列组成，每个像素是由一些比特编码来表示亮度和颜色。
通过使用图像内和图像间的冗余来降低编码的比特数，视频能够被压缩，因而可用比特率(bps)来权衡视频质量。

用户观看流式视频时向服务器请求视频文件，接收的数据收集在应用缓存中，达到一定限度后应用程序开始播放视频，应用程序周期性地从缓存中抓取帧，对这些帧解压缩并且在屏幕上展现。因此，流式视频应用接收到视频就进行播放，同时缓存该视频后面部分的帧。

经 HTTP 的动态适应性流**DASH**(Dynamic Adaptive Streaming over HTTP) 将视频以不同比特率编码为几个不同的版本。客户动态地请求来自不同版本且长度为几秒的视频段数据块，根据实时带宽切换选择合适速率版本的块。
服务器通过一个**告示文件**(manifest file)为每个版本提供了一个URL及其比特率。客户端首先请求该告示文件，然后周期性地测量服务器到客户端的带宽，自适应决定请求块的时间，类型和位置，通过在HTTP GET请求报文中指定一个URL和一个字节范围获取视频的不同块。

### 内容分发网络CDN

CDN(Content Distribution Networks/Content Delivery Network)全网部署缓存服务器节点，存储服务内容，就近为用户提供服务

缓存服务器安置原则：
- enter deep：将CDN服务器部署至接近本地ISP的深入位置
- bring home：将服务器集中部署在少数关键位置，通常放置在IXP

CND在缓存服务器节点中存储内容的多个拷贝，用户请求内容时重定向到其中一个，从其中获取内容
大多数 CDN 利用 DNS 来截获并重定向请求，在 DNS 解析时，CDN 内部的 DNS 智能调度系统通过负载均衡、网路等情况来选择出与主机最合适的资源服务器的 IP 作为 DNS 解析结果

CDN 有两个关键组成部分：**全局负载均衡**和**缓存系统**

全局负载均衡（Global Sever Load Balance）一般简称为 GSLB，它是 CDN 的“大脑”，主要的职责是当用户接入网络的时候在 CDN 专网中挑选出一个“最佳”节点提供服务，解决的是用户如何找到“最近的”边缘节点，对整个 CDN 网络进行“负载均衡”

缓存系统有选择地缓存那些最常用的那些资源

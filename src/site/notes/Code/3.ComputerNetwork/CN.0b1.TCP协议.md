---
{"dg-publish":true,"permalink":"/Code/3.ComputerNetwork/CN.0b1.TCP协议/","title":"TCP 协议","tags":[2,3,4],"noteIcon":""}
---


# TCP 协议

## TCP 概述

TCP 是**面向连接的、可靠的、基于字节流**的全双工传输层通信协议
- **面向连接** - 单个发送方与单个接收方进行连接，在发送数据前两个进程需要先通过握手(交换控制报文)建立连接(初始化发送方、接收方的状态变量)
- **可靠** - 无论的网络链路中出现了怎样的链路变化，TCP 都可以**保证一个报文一定能够到达接收端**，**TCP 报文是有序的**，当前一个 TCP 报文没有收到的时候持续等待，同时对重复的 TCP 报文自动丢弃
- **基于字节流** - TCP 将数据看成一个无结构的、有序的流，用户消息通过 TCP 协议传输时可能会被操作系统分组成多个的 TCP 报文进入流中，接收方程序必须**知道消息的边界**以读出一个有效的用户消息

### 报文格式

<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="401px" width="475" viewBox="-10 -10 381 421" content="&lt;mxGraphModel dx=&quot;686&quot; dy=&quot;1047&quot; grid=&quot;1&quot; gridSize=&quot;10&quot; guides=&quot;1&quot; tooltips=&quot;1&quot; connect=&quot;1&quot; arrows=&quot;1&quot; fold=&quot;1&quot; page=&quot;0&quot; pageScale=&quot;1&quot; pageWidth=&quot;827&quot; pageHeight=&quot;1169&quot; math=&quot;0&quot; shadow=&quot;0&quot;&gt;&lt;root&gt;&lt;mxCell id=&quot;0&quot;/&gt;&lt;mxCell id=&quot;1&quot; parent=&quot;0&quot;/&gt;&lt;mxCell id=&quot;2&quot; value=&quot;&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;470&quot; y=&quot;340&quot; width=&quot;360&quot; height=&quot;400&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;3&quot; value=&quot;TCP报文格式&quot; style=&quot;text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=18;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;590&quot; y=&quot;350&quot; width=&quot;120&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;6&quot; value=&quot;源端口号 (16 bit)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=14;fillColor=#eeeeee;strokeColor=#36393d;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;490&quot; y=&quot;390&quot; width=&quot;160&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;20&quot; value=&quot;目标端口号 (16 bit)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=14;fillColor=#eeeeee;strokeColor=#36393d;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;650&quot; y=&quot;390&quot; width=&quot;160&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;21&quot; value=&quot;序列号 (32 bit)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=14;fillColor=#cdeb8b;strokeColor=#36393d;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;490&quot; y=&quot;430&quot; width=&quot;320&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;22&quot; value=&quot;确认应答号 (32 bit)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=14;fillColor=#ffcccc;strokeColor=#36393d;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;490&quot; y=&quot;470&quot; width=&quot;320&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;24&quot; value=&quot;校验和 (16 bit)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=14;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;490&quot; y=&quot;550&quot; width=&quot;160&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;25&quot; value=&quot;紧急指针 (16 bit)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=14;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;650&quot; y=&quot;550&quot; width=&quot;160&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;27&quot; value=&quot;窗口大小 (16 bit)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=14;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;650&quot; y=&quot;510&quot; width=&quot;160&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;28&quot; value=&quot;首部&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;长度&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;(4 bit)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=10;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;490&quot; y=&quot;510&quot; width=&quot;40&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;29&quot; value=&quot;保留&amp;lt;br style=&amp;quot;font-size: 12px&amp;quot;&amp;gt;(6 bit)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=12;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;530&quot; y=&quot;510&quot; width=&quot;60&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;30&quot; value=&quot;U&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;R&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;G&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=10;horizontal=1;verticalAlign=middle;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;590&quot; y=&quot;510&quot; width=&quot;10&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;33&quot; value=&quot;A&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;C&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;K&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=10;horizontal=1;verticalAlign=middle;strokeColor=#36393d;fillColor=#ffff88;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;600&quot; y=&quot;510&quot; width=&quot;10&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;34&quot; value=&quot;R&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;S&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;T&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=10;horizontal=1;verticalAlign=middle;strokeColor=#36393d;fillColor=#ffff88;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;620&quot; y=&quot;510&quot; width=&quot;10&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;35&quot; value=&quot;S&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;Y&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;N&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=10;horizontal=1;verticalAlign=middle;strokeColor=#36393d;fillColor=#ffff88;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;630&quot; y=&quot;510&quot; width=&quot;10&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;36&quot; value=&quot;F&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;I&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;N&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=10;horizontal=1;verticalAlign=middle;strokeColor=#36393d;fillColor=#ffff88;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;640&quot; y=&quot;510&quot; width=&quot;10&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;40&quot; value=&quot;P&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;S&amp;lt;br style=&amp;quot;font-size: 10px;&amp;quot;&amp;gt;H&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=10;horizontal=1;verticalAlign=middle;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;610&quot; y=&quot;510&quot; width=&quot;10&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;41&quot; value=&quot;选项 (长度可变)&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=14;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;490&quot; y=&quot;590&quot; width=&quot;320&quot; height=&quot;40&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;42&quot; value=&quot;数据&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;fontSize=14;fillColor=#ffe6cc;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;490&quot; y=&quot;630&quot; width=&quot;320&quot; height=&quot;90&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;/root&gt;&lt;/mxGraphModel&gt;"><style type="text/css">/**/</style><rect x="0.5" y="0.5" width="360" height="400" fill="#ffffff" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 26px; margin-left: 122px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">TCP报文格式</div></div></div></foreignObject></g><rect x="20.5" y="50.5" width="160" height="40" fill="#eeeeee" stroke="#36393d" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 158px; height: 1px; padding-top: 71px; margin-left: 22px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">源端口号 (16 bit)</div></div></div></foreignObject></g><rect x="180.5" y="50.5" width="160" height="40" fill="#eeeeee" stroke="#36393d" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 158px; height: 1px; padding-top: 71px; margin-left: 182px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">目标端口号 (16 bit)</div></div></div></foreignObject></g><rect x="20.5" y="90.5" width="320" height="40" fill="#cdeb8b" stroke="#36393d" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 318px; height: 1px; padding-top: 111px; margin-left: 22px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">序列号 (32 bit)</div></div></div></foreignObject></g><rect x="20.5" y="130.5" width="320" height="40" fill="#ffcccc" stroke="#36393d" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 318px; height: 1px; padding-top: 151px; margin-left: 22px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">确认应答号 (32 bit)</div></div></div></foreignObject></g><rect x="20.5" y="210.5" width="160" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 158px; height: 1px; padding-top: 231px; margin-left: 22px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">校验和 (16 bit)</div></div></div></foreignObject></g><rect x="180.5" y="210.5" width="160" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 158px; height: 1px; padding-top: 231px; margin-left: 182px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">紧急指针 (16 bit)</div></div></div></foreignObject></g><rect x="180.5" y="170.5" width="160" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 158px; height: 1px; padding-top: 191px; margin-left: 182px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">窗口大小 (16 bit)</div></div></div></foreignObject></g><rect x="20.5" y="170.5" width="40" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 191px; margin-left: 22px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">首部<br style="font-size: 10px" />长度<br style="font-size: 10px" />(4 bit)</div></div></div></foreignObject></g><rect x="60.5" y="170.5" width="60" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 191px; margin-left: 62px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">保留<br style="font-size: 12px" />(6 bit)</div></div></div></foreignObject></g><rect x="120.5" y="170.5" width="10" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 8px; height: 1px; padding-top: 191px; margin-left: 122px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">U<br style="font-size: 10px" />R<br style="font-size: 10px" />G</div></div></div></foreignObject></g><rect x="130.5" y="170.5" width="10" height="40" fill="#ffff88" stroke="#36393d" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 8px; height: 1px; padding-top: 191px; margin-left: 132px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">A<br style="font-size: 10px" />C<br style="font-size: 10px" />K</div></div></div></foreignObject></g><rect x="150.5" y="170.5" width="10" height="40" fill="#ffff88" stroke="#36393d" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 8px; height: 1px; padding-top: 191px; margin-left: 152px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">R<br style="font-size: 10px" />S<br style="font-size: 10px" />T</div></div></div></foreignObject></g><rect x="160.5" y="170.5" width="10" height="40" fill="#ffff88" stroke="#36393d" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 8px; height: 1px; padding-top: 191px; margin-left: 162px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">S<br style="font-size: 10px" />Y<br style="font-size: 10px" />N</div></div></div></foreignObject></g><rect x="170.5" y="170.5" width="10" height="40" fill="#ffff88" stroke="#36393d" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 8px; height: 1px; padding-top: 191px; margin-left: 172px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">F<br style="font-size: 10px" />I<br style="font-size: 10px" />N</div></div></div></foreignObject></g><rect x="140.5" y="170.5" width="10" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 8px; height: 1px; padding-top: 191px; margin-left: 142px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">P<br style="font-size: 10px" />S<br style="font-size: 10px" />H</div></div></div></foreignObject></g><rect x="20.5" y="250.5" width="320" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 318px; height: 1px; padding-top: 271px; margin-left: 22px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">选项 (长度可变)</div></div></div></foreignObject></g><rect x="20.5" y="290.5" width="320" height="90" fill="#ffe6cc" stroke="#000000" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 318px; height: 1px; padding-top: 336px; margin-left: 22px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">数据</div></div></div></foreignObject></g></svg>

TCP 首部信息：
- *源端口号* (16bit)
- *目标端口号* (16bit)
- *序列号* (32bit) - 报文段首字节在字节流中的编号
- *确认号* (32bit) - 期望从另一方收到的下一个字节的序号
- *接收窗口* (16bit) - 愿意接收的字节数量
- *首部长度/数据偏移* (4bit) - TCP 首部长度(以4bytes(32bits) 的字为单位)
- 保留字段 (6bit) - 保留为今后使用，不使用
- *标志字段* (6bit)
	- *ACK* - 指示确认应答字段值的有效性
	- *RST*、*SYN*和*FIN* - 用于连接建立和断开
	- URG - 紧急数据，不使用
	- PSH - 马上推出(立即上交)数据，不使用
- *校验和* (16bit)
- 紧急数据指针 (16bit) - 不使用
- *选项* (不定长)
- *填充* - 使整个首部长度是 32bit(字大小)的整数倍

### 报文编号

TCP隐式地对字节流中的每一个字节编号，**序列号**是当前报文段首字节的字节流编号，**确认号**为希望对方主机发送的下一报文段所含数据的首字节的编号
序号到达2^32-1后重新从0开始

一条 TCP 连接的双方均可随机地选择初始序列号，这样做可以**减少两台主机的新建连接受到仍在网络中存在的过期连接的报文段的影响**

**序列号 = 上一次发送的序列号 + len(上一报文的数据长度)**
特殊情况，如果上一次发送的报文是 SYN 报文或者 FIN 报文，则改为上一次发送的序列号 + 1
**确认号 = 上一次收到的报文中的序列号 + len(上一报文的数据长度)**
特殊情况，如果收到的是 SYN 报文或者 FIN 报文，则改为上一次收到的报文中的序列号 + 1

TCP 采用**累积确认/累积应答**模式，接收方发送确认号 X 代表 X 之前的所有数据都已收到

> [!note] 延迟确认
> 没有携带数据的 ACK 报文也有 40 个字节的 IP 头和 TCP 头，单独发送的效率很低
> 为了解决 ACK 传输效率低问题，衍生出了 *TCP 延迟确认*
>
> TCP 延迟确认的策略：
>- 当有响应数据要发送时，ACK 会随着响应数据一起立刻发送给对方
>- 当没有响应数据要发送时，ACK 将会延迟一段时间，以等待是否有响应数据可以一起发送
>- 如果在延迟等待发送 ACK 期间，对方的第二个数据报文又到达了，这时就会立刻发送 ACK

### 拆包&粘包

TCP 传输协议是面向流的，没有数据包界限，客户端向服务端发送数据时，可能将一个完整的报文拆分成多个小报文进行发送，也可能将多个报文合并成一个大的报文进行发送，因此就有了拆包和粘包

**产生原因：**
- 拆包：网络通信每次可以发送的数据包大小受 MTU 传输单元大小、MSS 最大分段大小、滑动窗口等多种因素限制，如果一次传输的网络包数据大小超过传输单元大小，那么数据可能会拆分为多个数据包发送出去
- 粘包：当两个消息的某个部分内容被分到同一个 TCP 报文时，接收方如果不知道消息的边界就无法读出有效的消息
    - 如果每次请求的网络包数据都很小，一共请求了 10000 次，TCP 并不会分别发送 10000 次，因为 TCP 采用的 Nagle 算法对此作出了优化，Nagle 算法可以理解为**批量发送**，在数据未得到确认之前先写入缓冲区，等待数据确认或者缓冲区积攒到一定大小再把数据包发送出去

**拆包解决方案：**
TCP 将数据依照*最大报文段长度*(MSS)分割，加上 TCP 首部后形成多个 TCP 报文段，然后下发至网络层

> [!note] MSS
> MSS通常根据最初确定的由本地发送主机发送的*最大链路层帧长度*(即所谓的最大传输单元(MTU))来设置
> TCP 与 IP 首部长度之和通常为40bytes，以太网和 PPP 链路层协议都具有1500字节的 MTU，因此 MSS 的典型值为1460字节
> TCP 通过 MSS 保证**一个完整 TCP 报文段在 IP 层不被分片**，以免包含部分 TCP 报文段的单个 IP 分片丢失时需要重传整个 TCP 报文，开销过大
> 为了达到最佳的传输效能， TCP 协议在**建立连接的时候通常要协商双方的 MSS 值**{ #mss}


**粘包解决方案：定义应用层的通信协议**
- 消息长度固定：每个数据报文长度固定，当接收方累计读取到固定长度的报文后，就认为已经获得一个完整的消息，当发送方的数据小于固定长度时空位补齐，缺点在于固定长度值难以确定
- 特定分隔符：在每次发送报文的尾部加上特定分隔符，接收方根据分隔符进行消息拆分
- **消息长度+消息内容**(最常用)：消息头中存放消息的总长度，消息体存放实际的二进制的字节数据，接收方在解析数据时，首先读取消息头的长度字段 Len，然后紧接着读取长度为 Len 的字节数据，该数据即判定为一个完整的数据报文

## [[Code/3.ComputerNetwork/CN.0b1a.TCP连接管理\|连接管理]]

## 可靠性传输

TCP 的可靠数据传输为 [[Code/3.ComputerNetwork/CN.0b.传输层#可靠数据传输\|GBN 和 SR]] 的混合体

### 超时重传

TCP 采用*超时/重传机制*来处理报文段的丢失问题，在发送数据时设定定时器，指定时间内未收到对方的 ACK 报文则重传

**超时重传时间 RTO 根据往返延时(RTT)动态确定**，应该略大于报文往返 RTT 的值，取得无效重传和等待重传时间过长问题间的平衡
> ![9.jpg (1158×888) (xiaolincoding.com)|600](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP-%E5%8F%AF%E9%9D%A0%E7%89%B9%E6%80%A7/9.jpg)

推荐的初始 RTO 值为1秒，在第一次收到确认报文前的超时都将使 RTO 值成倍增加，以保证接收到首个确认报文段并更新 RTO
在 Linux 下，**α = 0.125，β = 0.25， μ = 1，∂ = 4**

此外如果超时重发的数据再次超时又需要重传时，TCP **加倍超时间隔**

### 快速重传

*快速重传*指发送方在定时器到期之前收到对同一报文段的**3个额外 ACK**，则立刻重传该报文段
快速重传避免了超时重传等待时间过长的问题

#### SACK

快速重传因为不确定丢失报文的数量，面临**重传一个还是重传所有报文的问题**
SACK 方法通过确认已收到的数据信息解决该问题
*选择性确认 SACK*在 ACK 报文的 TCP 头部**选项字段**里加入已收到的数据的信息
发送方由此可以知道哪些数据已被收到，只重传丢失的数据

<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="645.9999999999999px" width="450" viewBox="-10 -10 490.9999999999999 665.9999999999999" content="&lt;mxGraphModel dx=&quot;1678&quot; dy=&quot;1232&quot; grid=&quot;1&quot; gridSize=&quot;10&quot; guides=&quot;1&quot; tooltips=&quot;1&quot; connect=&quot;1&quot; arrows=&quot;1&quot; fold=&quot;1&quot; page=&quot;0&quot; pageScale=&quot;1&quot; pageWidth=&quot;827&quot; pageHeight=&quot;1169&quot; math=&quot;0&quot; shadow=&quot;0&quot;&gt;&lt;root&gt;&lt;mxCell id=&quot;0&quot;/&gt;&lt;mxCell id=&quot;1&quot; parent=&quot;0&quot;/&gt;&lt;mxCell id=&quot;2&quot; value=&quot;&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=#67AB9F;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-160&quot; y=&quot;45&quot; width=&quot;470&quot; height=&quot;645&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;4&quot; value=&quot;&quot; style=&quot;shape=singleArrow;direction=south;whiteSpace=wrap;html=1;arrowWidth=0.29619827270507815;arrowSize=0.05690200112082742;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-110&quot; y=&quot;110&quot; width=&quot;40&quot; height=&quot;570&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;5&quot; value=&quot;&quot; style=&quot;shape=singleArrow;direction=south;whiteSpace=wrap;html=1;arrowWidth=0.29619827270507815;arrowSize=0.05690200112082742;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;200&quot; y=&quot;110&quot; width=&quot;40&quot; height=&quot;570&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;6&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.116;entryY=0.605;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.054;exitY=0.352;exitDx=0;exitDy=0;exitPerimeter=0;strokeColor=#7EA6E0;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;4&quot; target=&quot;5&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;30&quot; y=&quot;290&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;80&quot; y=&quot;240&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;8&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.373;entryY=0.673;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.28;exitY=0.353;exitDx=0;exitDy=0;exitPerimeter=0;strokeColor=#7EA6E0;&quot; edge=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-84.12000000000012&quot; y=&quot;245.5999999999999&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;213.07999999999993&quot; y=&quot;298.6099999999999&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;11&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;exitX=0.188;exitY=0.355;exitDx=0;exitDy=0;exitPerimeter=0;fillColor=#f0a30a;strokeColor=#BD7000;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;4&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-74.08000000000004&quot; y=&quot;150.77999999999997&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;50&quot; y=&quot;238&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;12&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.167;entryY=0.355;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.131;exitY=0.654;exitDx=0;exitDy=0;exitPerimeter=0;strokeColor=#67AB9F;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;5&quot; target=&quot;4&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-200&quot; y=&quot;290&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;-150&quot; y=&quot;240&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;13&quot; value=&quot;&quot; style=&quot;verticalLabelPosition=bottom;verticalAlign=top;html=1;shape=mxgraph.basic.x;fillColor=#e51400;strokeColor=#B20000;fontColor=#ffffff;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;50&quot; y=&quot;230&quot; width=&quot;25&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;14&quot; value=&quot;发送方&quot; style=&quot;text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-110&quot; y=&quot;80&quot; width=&quot;50&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;15&quot; value=&quot;接收方&quot; style=&quot;text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;200&quot; y=&quot;80&quot; width=&quot;50&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;16&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.167;entryY=0.355;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.131;exitY=0.654;exitDx=0;exitDy=0;exitPerimeter=0;dashed=1;&quot; edge=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;212&quot; y=&quot;306&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;-82&quot; y=&quot;327&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;21&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.373;entryY=0.673;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.28;exitY=0.353;exitDx=0;exitDy=0;exitPerimeter=0;strokeColor=#7EA6E0;&quot; edge=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-83.10000000000001&quot; y=&quot;346&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;214.09999999999994&quot; y=&quot;399.01&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;22&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.167;entryY=0.355;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.131;exitY=0.654;exitDx=0;exitDy=0;exitPerimeter=0;dashed=1;&quot; edge=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;213.02&quot; y=&quot;406.4&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;-80.98&quot; y=&quot;427.4&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;23&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.373;entryY=0.673;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.28;exitY=0.353;exitDx=0;exitDy=0;exitPerimeter=0;strokeColor=#7EA6E0;&quot; edge=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-82.10000000000002&quot; y=&quot;436&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;215.0999999999999&quot; y=&quot;489.01&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;24&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.167;entryY=0.355;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.131;exitY=0.654;exitDx=0;exitDy=0;exitPerimeter=0;dashed=1;&quot; edge=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;214.01999999999998&quot; y=&quot;496.4000000000001&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;-79.98000000000013&quot; y=&quot;517.4000000000001&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;25&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.373;entryY=0.673;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.28;exitY=0.353;exitDx=0;exitDy=0;exitPerimeter=0;fillColor=#f0a30a;strokeColor=#BD7000;&quot; edge=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-83.00000000000003&quot; y=&quot;530&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;214.1999999999999&quot; y=&quot;583.01&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;26&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;entryX=0.167;entryY=0.355;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.131;exitY=0.654;exitDx=0;exitDy=0;exitPerimeter=0;strokeColor=#67AB9F;&quot; edge=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;213.11999999999998&quot; y=&quot;590.4000000000001&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;-80.88000000000014&quot; y=&quot;611.4000000000001&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;30&quot; value=&quot;100~199&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#7EA6E0;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;32.5&quot; y=&quot;140&quot; width=&quot;60&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;31&quot; value=&quot;ACK 200&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#67AB9F;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;32.5&quot; y=&quot;180&quot; width=&quot;60&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;32&quot; value=&quot;300~399&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#7EA6E0;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;32.5&quot; y=&quot;259&quot; width=&quot;60&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;34&quot; value=&quot;200~299&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#FFB570;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-40&quot; y=&quot;214&quot; width=&quot;60&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;37&quot; value=&quot;ACK 200&amp;lt;br&amp;gt;SACK 300~400&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#7EA6E0;fontSize=11;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;21.25&quot; y=&quot;303&quot; width=&quot;82.5&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;40&quot; value=&quot;400~499&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#7EA6E0;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;32.5&quot; y=&quot;358&quot; width=&quot;60&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;41&quot; value=&quot;ACK 200&amp;lt;br&amp;gt;SACK 300~500&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#7EA6E0;fontSize=11;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;21.25&quot; y=&quot;402&quot; width=&quot;82.5&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;42&quot; value=&quot;500~599&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#7EA6E0;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;32.5&quot; y=&quot;450&quot; width=&quot;60&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;43&quot; value=&quot;ACK 200&amp;lt;br&amp;gt;SACK 300~600&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#7EA6E0;fontSize=11;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;21.25&quot; y=&quot;494&quot; width=&quot;82.5&quot; height=&quot;26&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;44&quot; value=&quot;200~299&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontColor=#FFB570;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;32.5&quot; y=&quot;540&quot; width=&quot;60&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;45&quot; value=&quot;ACK 600&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=none;fontSize=11;fontColor=#67AB9F;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;21.25&quot; y=&quot;587&quot; width=&quot;82.5&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;/root&gt;&lt;/mxGraphModel&gt;"><style type="text/css">/**/</style><rect x="0.5" y="0.5" width="470" height="645" fill="#ffffff" stroke="#67ab9f" pointer-events="none"/><path d="M -214.5 344.58 L 323.07 344.58 L 323.07 330.5 L 355.5 350.5 L 323.07 370.5 L 323.07 356.42 L -214.5 356.42 Z" fill="#ffffff" stroke="#000000" stroke-miterlimit="10" transform="rotate(90,70.5,350.5)" pointer-events="none"/><path d="M 95.5 344.58 L 633.07 344.58 L 633.07 330.5 L 665.5 350.5 L 633.07 370.5 L 633.07 356.42 L 95.5 356.42 Z" fill="#ffffff" stroke="#000000" stroke-miterlimit="10" transform="rotate(90,380.5,350.5)" pointer-events="none"/><path d="M 76.42 96.28 L 369.98 130.87" fill="none" stroke="#7ea6e0" stroke-miterlimit="10" pointer-events="none"/><path d="M 375.19 131.49 L 367.83 134.15 L 369.98 130.87 L 368.65 127.19 Z" fill="#7ea6e0" stroke="#7ea6e0" stroke-miterlimit="10" pointer-events="none"/><path d="M 76.38 201.1 L 367.31 252.99" fill="none" stroke="#7ea6e0" stroke-miterlimit="10" pointer-events="none"/><path d="M 372.48 253.91 L 364.97 256.13 L 367.31 252.99 L 366.2 249.24 Z" fill="#7ea6e0" stroke="#7ea6e0" stroke-miterlimit="10" pointer-events="none"/><path d="M 76.3 172.66 L 204.21 192.52" fill="none" stroke="#bd7000" stroke-miterlimit="10" pointer-events="none"/><path d="M 209.4 193.33 L 201.94 195.71 L 204.21 192.52 L 203.02 188.8 Z" fill="#bd7000" stroke="#bd7000" stroke-miterlimit="10" pointer-events="none"/><path d="M 374.34 140.17 L 82.65 160.25" fill="none" stroke="#67ab9f" stroke-miterlimit="10" pointer-events="none"/><path d="M 77.42 160.61 L 84.16 156.64 L 82.65 160.25 L 84.64 163.62 Z" fill="#67ab9f" stroke="#67ab9f" stroke-miterlimit="10" pointer-events="none"/><path d="M 210.5 185.5 L 217.79 185.5 L 223 191.42 L 228.21 185.5 L 235.5 185.5 L 226.65 195.5 L 235.5 205.5 L 228.21 205.5 L 223 199.58 L 217.79 205.5 L 210.5 205.5 L 218.83 195.5 Z" fill="#e51400" stroke="#b20000" stroke-miterlimit="10" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 48px; height: 1px; padding-top: 45px; margin-left: 52px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">发送方</div></div></div></foreignObject></g><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 48px; height: 1px; padding-top: 45px; margin-left: 362px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">接收方</div></div></div></foreignObject></g><path d="M 372.5 261.5 L 84.85 282.05" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 79.62 282.42 L 86.35 278.43 L 84.85 282.05 L 86.85 285.41 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 77.4 301.5 L 368.33 353.39" fill="none" stroke="#7ea6e0" stroke-miterlimit="10" pointer-events="none"/><path d="M 373.5 354.31 L 365.99 356.53 L 368.33 353.39 L 367.22 349.64 Z" fill="#7ea6e0" stroke="#7ea6e0" stroke-miterlimit="10" pointer-events="none"/><path d="M 373.52 361.9 L 85.87 382.45" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 80.64 382.82 L 87.37 378.83 L 85.87 382.45 L 87.87 385.81 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 78.4 391.5 L 369.33 443.39" fill="none" stroke="#7ea6e0" stroke-miterlimit="10" pointer-events="none"/><path d="M 374.5 444.31 L 366.99 446.53 L 369.33 443.39 L 368.22 439.64 Z" fill="#7ea6e0" stroke="#7ea6e0" stroke-miterlimit="10" pointer-events="none"/><path d="M 374.52 451.9 L 86.87 472.45" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 81.64 472.82 L 88.37 468.83 L 86.87 472.45 L 88.87 475.81 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 77.5 485.5 L 368.43 537.39" fill="none" stroke="#bd7000" stroke-miterlimit="10" pointer-events="none"/><path d="M 373.6 538.31 L 366.09 540.53 L 368.43 537.39 L 367.32 533.64 Z" fill="#bd7000" stroke="#bd7000" stroke-miterlimit="10" pointer-events="none"/><path d="M 373.62 545.9 L 85.97 566.45" fill="none" stroke="#67ab9f" stroke-miterlimit="10" pointer-events="none"/><path d="M 80.74 566.82 L 87.47 562.83 L 85.97 566.45 L 87.97 569.81 Z" fill="#67ab9f" stroke="#67ab9f" stroke-miterlimit="10" pointer-events="none"/><rect x="193" y="95.5" width="60" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 110px; margin-left: 194px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #7EA6E0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">100~199</div></div></div></foreignObject></g><rect x="193" y="135.5" width="60" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 150px; margin-left: 194px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #67AB9F; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">ACK 200</div></div></div></foreignObject></g><rect x="193" y="214.5" width="60" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 229px; margin-left: 194px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #7EA6E0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">300~399</div></div></div></foreignObject></g><rect x="120.5" y="169.5" width="60" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 184px; margin-left: 122px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #FFB570; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">200~299</div></div></div></foreignObject></g><rect x="181.75" y="258.5" width="82.5" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 81px; height: 1px; padding-top: 273px; margin-left: 183px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #7EA6E0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">ACK 200<br />SACK 300~400</div></div></div></foreignObject></g><rect x="193" y="313.5" width="60" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 328px; margin-left: 194px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #7EA6E0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">400~499</div></div></div></foreignObject></g><rect x="181.75" y="357.5" width="82.5" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 81px; height: 1px; padding-top: 372px; margin-left: 183px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #7EA6E0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">ACK 200<br />SACK 300~500</div></div></div></foreignObject></g><rect x="193" y="405.5" width="60" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 420px; margin-left: 194px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #7EA6E0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">500~599</div></div></div></foreignObject></g><rect x="181.75" y="449.5" width="82.5" height="26" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 81px; height: 1px; padding-top: 462px; margin-left: 183px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #7EA6E0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">ACK 200<br />SACK 300~600</div></div></div></foreignObject></g><rect x="193" y="495.5" width="60" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 510px; margin-left: 194px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #FFB570; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">200~299</div></div></div></foreignObject></g><rect x="181.75" y="542.5" width="82.5" height="30" fill="#ffffff" stroke="none" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 81px; height: 1px; padding-top: 557px; margin-left: 183px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #67AB9F; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">ACK 600</div></div></div></foreignObject></g></svg>

> ![|650](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP-%E5%8F%AF%E9%9D%A0%E7%89%B9%E6%80%A7/11.jpg)

#### D-SACK

**Duplicate SACK** 又称 `D-SACK` 使用 SACK 来告诉发送方**有哪些数据被重复接收**

用途：
- 可以让「发送方」知道，是发出去的包丢了，还是接收方回应的 ACK 包丢了
- 可以知道是不是「发送方」的数据包被网络延迟了
- 可以知道网络中是不是把「发送方」的数据包给复制了

> ![13.jpg (962×1082) (xiaolincoding.com)|550](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP-%E5%8F%AF%E9%9D%A0%E7%89%B9%E6%80%A7/13.jpg?image_process=watermark,text_5YWs5LyX5Y-377ya5bCP5p6XY29kaW5n,type_ZnpsdHpoaw,x_10,y_10,g_se,size_20,color_0000CD,t_70,fill_0)

### 流量控制 - 滑动窗口

滑动窗口指定**发送方无需等待 ACK 报文而可以继续发送数据的最大值**

通常**窗口大小由接收方的窗口大小决定**，依靠 TCP 头部**接收窗口字段**交流控制

#### 发送方滑动窗口 swnd

> ![19.jpg (1428×513) (xiaolincoding.com)|825](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP-%E5%8F%AF%E9%9D%A0%E7%89%B9%E6%80%A7/19.jpg?image_process=watermark,text_5YWs5LyX5Y-377ya5bCP5p6XY29kaW5n,type_ZnpsdHpoaw,x_10,y_10,g_se,size_20,color_0000CD,t_70,fill_0)

`SND.WND`：表示发送窗口的大小(由接收方指定)
`SND.UNA` (Send Unacknowledged)：一个绝对指针，指向已发送但未收到确认的第一个字节的序列号，也就是 #2 的第一个字节
`SND.NXT`：一个绝对指针，指向未发送但可发送范围的第一个字节的序列号，也就是 #3 的第一个字节
指向 #4 的第一个字节是个相对指针，值为 SND.UNA + SND.WND
**可用窗口大小 = SND.WND -(SND.NXT - SND.UNA)**

#### 接收方滑动窗口 rwnd

> ![20.jpg (1429×498) (xiaolincoding.com)|825](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP-%E5%8F%AF%E9%9D%A0%E7%89%B9%E6%80%A7/20.jpg)

`RCV.WND`：表示接收窗口的大小，会被通告给发送方
`RCV.NXT`：一个绝对指针，指向期望从发送方发送来的下一个数据字节的序列号，也就是 #3 的第一个字节
指向 #4 的第一个字节是个相对指针，值为 RCV.NXT + RCV.WND

`SND.NXT` 即为下一 TCP 报文的*序列号*首部字段
`RCV.NXT` 即为下一 TCP 报文的*确认号*首部字段

滑动窗口的大小受系统内存缓冲区的限制，当缓冲区不够的情况下，如果服务器应用程序没有及时读取接收数据，接收窗口会不断收缩并通告客户端

当服务端系统资源非常紧张时，操作系统可能会直接减少接收缓冲区大小，进而减少接收方窗口大小，这时如果应用程序无法及时读取缓存数据，会出现数据包丢失的现象
为了防止这种情况发生，**TCP 规定不允许同时减少缓存和收缩窗口**，采用先收缩窗口，过段时间再减少缓存的方式避免丢包情况

#### 零窗口

当发送方收到接收窗口为 0 的 ACK 报文时，将通过持续计时器间断发送仅1字节的窗口探测报文段，接收方收到后通过 ACK 报文反馈当前接收窗口大小
窗口探测的次数一般为 3 次，每次大约 30-60 秒
如果 3 次过后接收窗口还是 0 的话，部分 TCP 实现就会发 `RST` 报文来中断连接

#### 糊涂窗口综合症

*糊涂窗口综合症*指接收方窗口过小导致发送方每个 TCP 报文都传输小数据，浪费资源

解决方案：
- 让接收方不通告小窗口给发送方
    当接收窗口小于 `min(MSS，缓存空间/2)` 时，向发送方通告窗口大小为0
- 让发送方避免发送小数据
    使用 **Nagle 算法**，该算法的思路是延时处理，只有满足以下条件中的任意一个，才可以发送数据：
    - 窗口大小 >= MSS 并且数据大小 >= MSS
    - 收到之前发送数据的 ACK 响应报文

## 拥塞控制

网络所需传输的数据超过了网络的处理能力即引发网络拥塞

**拥塞的代价：**
- 为了达到一个有效输出，网络需要做更多的工作(重传)
- 由于传输速度大幅减慢出现超时引起的没有必要的重传
- 某一分组丢失时，任何用于传输这个分组的上游传输能力都被浪费

常见的拥塞控制方法包括**端到端拥塞控制**和**网络辅助拥塞控制**
端到端拥塞控制中端系统通过对网络行为的观察推断网络拥塞
网络辅助拥塞控制中路由器向发送方端系统提供网络拥塞的显式反馈信息

IP层不向端系统提供显式的网络拥塞反馈，因此**TCP使用端到端拥塞控制**，每一个发送方根据所感知到的网络拥塞程度来限制其能向连接发送流量的速率

TCP 连接的每一端都是由一个接收缓存、一个发送缓存和几个变量组成，运行在发送方的 TCP 拥塞控制机制跟踪一个额外的变量*拥塞窗口 cwnd*
发送窗口的值 `swnd = min(cwnd, rwnd)`

**TCP 通过报文的超时感知网络拥塞**，同时采用四种算法控制拥塞：
- 慢启动
- 拥塞避免
- 拥塞发生
- 快速恢复

### TCP 拥塞控制算法

TCP使用ACK来触发(或计时)增大它的拥塞窗口长度，感知到丢包时降低其发送速率

TCP拥塞控制算法使用AIMD(线性增、乘性减少)，包括三个部分
- **慢启动(slow-start, SS)阶段**
  - 接收到的每个 ACK 报文使 `cwnd += 1`，因此每经过1RTT 后 `cwnd *= 2` (指数型增长)
- **拥塞避免(congestion-avoidance, CA)阶段**
  - 接收到的每个 ACK 报文使 cwnd 增加1/cwnd，也即每经过1RTT 后 `cwnd += 1`
- **快速恢复(fast recovery，FR)阶段**
  - 对于每个冗余 ACK，`cwnd += 1`，当丢失报文段的 ACK 到达时，令 `cwnd = ssthresh` ，进入 CA 阶段

1. 连接刚建立时，cwnd 通常置为1(单位为 [[Code/3.ComputerNetwork/CN.0b1.TCP协议#^mss\|MSS]])，连接处于 **慢启动(slow-start, SS)阶段**
    - 接收到的每个 ACK 报文使 `cwnd += 1`，因此每经过1RTT 后 `cwnd *= 2` (指数型增长)
2. 当拥塞窗口 cwnd 大小超过慢启动门限 `ssthresh` 时进入**拥塞避免(congestion-avoidance, CA)阶段**
    - 接收到的每个 ACK 报文使 cwnd 增加1/cwnd，也即每经过1RTT 后 `cwnd += 1`
3. 发生超时重传时，`ssthresh = cwnd/2`，cwnd 重设为初始值(1)，再次进入 SS 阶段
4. cwnd 增长至 ssthresh 值后再次进入 CA 阶段
5. 发生快速重传时，`ssthresh = cwnd/2`，`cwnd = ssthresh+3` (将3个冗余 ACK 计算在内)，进入 FR 阶段
    - 对于每个冗余 ACK，`cwnd += 1`
        - 如缺失报文段最终超时，则 cwnd 重设为初始值，进入 SS 阶段
        - 收到缺失报文段的 ACK 后，令 `cwnd = ssthresh`，进入 CA 阶段

> 一般来说 `ssthresh` 的初始大小是 `65535` bytes

> ![|600](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP-%E5%8F%AF%E9%9D%A0%E7%89%B9%E6%80%A7/29.jpg?image_process=watermark,text_5YWs5LyX5Y-377ya5bCP5p6XY29kaW5n,type_ZnpsdHpoaw,x_10,y_10,g_se,size_20,color_0000CD,t_70,fill_0)
> ![|600](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/%E6%8B%A5%E5%A1%9E%E5%8F%91%E7%94%9F-%E5%BF%AB%E9%80%9F%E9%87%8D%E4%BC%A0.drawio.png?image_process=watermark,text_5YWs5LyX5Y-377ya5bCP5p6XY29kaW5n,type_ZnpsdHpoaw,x_10,y_10,g_se,size_20,color_0000CD,t_70,fill_0)

快速恢复阶段分析：
 - `ssthresh = cwnd/2`，`cwnd = ssthresh+3` - 快速恢复首先减小 cwnd 以避免网络拥塞
 - 对于每个冗余 ACK，`cwnd += 1` - 使得每个收到的重复的 ACK 包不占用拥塞窗口，目的是尽快将丢失的数据包发给目标

### 公平性

- 相同 RTT 下两条 TCP 连接基本实现平等地共享链路带宽
- 较小 RTT 能够享用更高吞吐量
- 无拥塞控制的 UDP 连接会压制 TCP 流量
- 应用程序可使用多个 TCP 连接来抢占带宽

## TCP-Socket 编程

> ![format,png-20230309230545997.png (1188×1007) (xiaolincoding.com)|600](https://cdn.xiaolincoding.com//mysql/other/format,png-20230309230545997.png)

1. 服务端和客户端初始化 `socket`，得到文件描述符
2. 服务端调用 `bind`，将 socket 绑定在指定的 IP 地址和端口
3. 服务端调用 `listen`，通过*监听 socket* 进行监听
4. 服务端调用 `accept`，等待客户端连接
5. 客户端调用 `connect`，向服务端的地址和端口发起连接请求
6. 服务端 `accept` 返回用于传输的*已连接 socket* 的文件描述符
7. 客户端调用 `write` 写入数据；服务端调用 `read` 读取数据
8. 客户端断开连接时，会调用 `close`，那么服务端 `read` 读取数据的时候，就会读取到了 `EOF`，待处理完数据后，服务端调用 `close`，表示连接关闭

**accpet 系统调用并不参与 TCP 三次握手过程**，它只是负责从 TCP 全连接队列取出一个已经建立连接的 socket

客户端可以自己连自己形成连接(**TCP 自连接**)，也可以两个客户端同时向对方发出请求建立连接(**TCP 同时打开**)，这两个情况都有个共同点，就是**没有服务端参与，也就是没有 listen，就能 TCP 建立连接**

---
{"dg-publish":true,"permalink":"/Code/3.ComputerNetwork/ComputerNetwork.0c.网络层/","title":"网络层","noteIcon":""}
---


# 网络层

网络层提供在发送主机和接收主机对之间传送**数据报/段**(segment)的服务

网络层能够被分解为两个相互作用的部分，即**数据平面**和**控制平面**，与之相关的功能包括**转发**和**路由选择**
**转发**(forwarding)指将分组从路由器的一个输入链路接口转发到合适的输出链路接口的路由器本地动作，转发是在**数据平面**中实现的唯一功能，也是本地的、每个路由器都具有的功能
**路由选择**(routing)指使用路由算法确定分组从源到目的地所采取的端到端路径的网络范围处理过程，路由选择在网络层的**控制平面**中实现。
**路由**：按照某种指标(传输延迟,所经过的站点数目等)找到一条从源节点到目标节点的较好路径

网络层功能的实现有**传统**和**软件定义网络**(Software-Defined Networking, SDN)两种
传统方法中**路由选择**的实现为在每台路由器内运行路由选择算法，与在其他路由器中的路由选择算法通信(根据路由选择协议交换包含路由选择信息的路由选择报文)，以计算出它的转发表的值
SDN方法中**路由选择**的实现为远程控制器计算和分发转发表以供每台路由器所使用

**网络服务模型**(network service model)定义了分组在发送与接收端系统之间的端到端运输特性。
网络层相关服务：确保交付、具有时延上界的确保交付、有序分组交付、确保最小带宽、安全性
互联网的网络层仅提供尽力而为服务，但网络层的基本尽力而为服务模型与适当带宽供给相结合已被证明“足够好”，能够用于大量的应用

## IP协议

### IPv4

#### 数据报格式

数据报首部信息(通常为20byte)：
- **版本**(4bit) - 规定数据报的IP协议版本
- 首部长度(4bit) - 大多数IP数据报不包含选项，一般的IP数据报具有20byte的首部。
- 服务类型(8bit) - 区别不同类型的数据报，现在不太用
- **数据报长度**(16bit) - IP数据报的总长度
- **标识号**(16bit) - 标识属于同一原始数据报的片
- **标志**(3bit) - 标识当前片是否为原始数据报的最后一片
- **片位移**(13bit) - 指定该片在原始数据报中的位置
- **寿命**(TTL)(8bit) - 每当一台路由器处理数据报时，该字段的值减1，为0则丢弃该数据报
- **协议**(8bit) - 指示了IP数据报的数据部分应交给哪个特定的传输层协议
- **首部检验和**(16bit) - 同UDP[[Code/3.ComputerNetwork/ComputerNetwork.0b.传输层#^checksum\|校验和]]
- **源IP地址**(32bit)
- **目标IP地址**(32bit)
- 选项 - 允许IP首部被扩展

#### 分片

一个链路层帧能承载的最大数据量叫作**最大传送单元**(Maximum Transmission Unit, MTU) ，在发送方与目的地路径上的每段链路可能使用不同的链路层协议，且每种协议可能具有不同的 MTU，因此IPv4协议下路由在出链路的MTU小于入链路的IP数据报长度时，将IP数据报中的数据分片成两个或更多个较小的IP数据报，用单独的链路层帧封装这些**片**(fragment)

发送主机在生成数据报时通过**标识号**区分每个数据报，路由器分片时令每片的标识号与源数据报相同，以使目标主机确认哪些数据报是同一原始较大数据报的片。分片时最后一片的**标志**设为0，其他片标志设为1，以使目标主机确认收到了全部的源数据报。同时**片位移**字段用于指定每片在原始数据报中的位置

#### IP地址

主机/路由器和物理链路的连接处叫作**接口**(interface)，一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联

每个IP地址长度为32比特(等价为4字节)，因此总共有2^32个(或大约40亿个)可能的IP地址。IP地址通常按**点分十进制记法**(dotted-decimal notation)书写，即地址中的每个字节用十进制形式书写，各字节间以句点隔开

将主机和路由器中接口间的连接断开所产生相互隔离的网络岛称为**子网**(subnet)。一个接口的IP地址的一部分由其连接的子网决定。
**子网掩码**(network mask)同样为32bit，通过将对应位置bit置1表示子网IP地址中的该位表示子网部分

在过去的**分类编址**(classful addressing)架构中，IP地址分为ABCDE五类
![](https://image.jiang849725768.asia/2022/202212231840463.png)
原始的A、B、C类网络的子网掩码分别为：
- A - 255.0.0.0 or 11111111 00000000 0000000 00000000
- B - 255.255.0.0 or 11111111 11111111 0000000 00000000
- C - 255.255.255.0 or 11111111 11111111 11111111 00000000
- D类为多播地址，E类为预留地址

此外存在一些特殊的IP地址：
- 子网部分全为0 - 本网络
- 主机部分全为0 - 本主机
- 主机部分全为1 - 广播地址，这个网络的所有主机
- 127.X.X.X - 回路地址，访问自身

还有一些仅用于局部网络中的地址，这些地址仅供专用地址使用，不会被当做公用地址来分配, 只在局部网络中用于区分不同的设备，路由器不对目标地址是专用地址的分组进行转发：
- A - 10.0.0.0-10.255.255.255
- B - 172.16.0.0-172.31.255.255
- C - 192.168.0.0-192.168.255.255

现在互联网的地址分配策略被称为**无类别域间路由选择**(Classless Inlerdomain Routing，CIDR)，该策略下子网部分可以在任意的位置，地址格式: a.b.c.d/x，其中x是IP地址中子网号的长度
CIDR下的子网掩码可为11111111 11111111 11111100 00000000(/22)

ISP从**因特网名字和编号分配机构**(Internet Corporation for Assigned Names and Numbers，**ICANN**)获取IP地址块
网络管理员从ISP获得地址块中分配一个小地址块用于子网
主机可通过系统管理员手动配置或**动态主机配置协议**(Dynamic Host Configuration, DHCP)自动获取IP地址以及子网掩码、第一跳路由器地址(常称为默认网关)、本地DNS服务器的地址等其他常用信息

**DHCP**又称即插即用协议(plug-and-play protocol)或零配置(zeroconf)协议，当一个新主机连接网络时
1. 主机通过255.255.255.255广播DHCP discover message
2. DHCP 服务器用DHCP offer message广播提供报文响应
3. 主机从一个或多个服务器提供中选择一个，并广播向选中的服务器提供用DHCP request message进行响应，回显配置的参数(DHCP offer message 中包含收到的发现报文的事务ID、向客户推荐的IP地址、子网掩码、IP地址租用期)
4. DHCP服务器使用DHCP ACK message广播响应，证实所要求的参数
![|575](https://image.jiang849725768.asia/2022/202212232029649.png)
在最简单场合下，每个子网将具有一台DHCP服务器。如果在某子网中没有服务器，则需要一个DHCP中继代理(通常是一台路由器)，这个代理知道用于该网络的DHCP服务器的地址。

使用单个网络前缀通告多个网络的能力通常称为**地址聚合**，也称为路由聚合或路由摘要

**网络地址转换**(Network Address Translation，**NAT**)被用于解决子网过大(IP地址不够用)的问题
NAT路由器对于外部互联网而言如同一个具有单一IP地址的单一设备
NAT路由器收到内网主机发送的数据报后
1. 生成一个未使用的端口号X，将内网IP地址及源端口与该端口号绑定，通过**NAT转换表**记录该绑定关系
2. 使用NAT路由器自身IP地址以及端口号X作为源主机地址和端口，向数据报中的目标主机及目标端口发送
3. 将Web服务器发回的响应报文通过NAT转换表查找后转发至相应的内网主机端口

NAT对于运行在内网中的服务器来说会引起问题，对这些问题的技术解决方案包括NAT穿越(NAT traversal)工具和通用即插即用(Universal Plug and Play, UPnP)
解决方案1：静态配置NAT，将服务器特定端口与NAT端口绑定
解决方案2：内网主机获取NAT服务器IP地址，动态进行NAT端口映射配置(UPnP)
解决方案3：在外部互联网中设置中继点，内网主机建立与中继的连接

### IPv6

IPv6用于解决32比特的IP地址空间被用尽以及IPv4中存在的一些问题

IPv6数据报首部(固定40byte)：
- **版本**(4bit) - 规定数据报的IP协议版本
- **流标签**(20bit) - 给属于特殊流的分组加上标签，准备用于服务质量控制
- **流量类型**(8bit) - 区别不同类型的数据报
- **有效载荷长度**(16bit) - IP数据报主体的长度
- **跳限制**(TTL)(8bit) - 每当一台路由器处理数据报时，该字段的值减1，为0则丢弃该数据报
- **下一个首部**(8bit) - 指示了IP数据报的数据部分应交给哪个特定的传输层协议，可指定选项
- **源IP地址**(128bit)
- **目标IP地址**(128bit)

***IPv6不允许在中间路由器上进行分片与重新组装***。这种操作只能在源与目的地执行。如果路由器收到的IPv6数据报因太大而不能转发到出链路上的话，则路由器丢掉该数据报并向发送方发回一个“分组太大”的ICMP差错报文

**隧道**被用于IPv4到IPv6的过渡，IPv6可使用IPv4隧道进行连接
在隧道发送端的IPv6节点可将整个IPv6数据报封装至一个IPv4数据报的数据(有效载荷)字段进行传输
隧道接收端的IPv6节点收到该IPv4数据报，并确定该IPv4数据报含有一个IPv6数据报(IPv4数据报将协议号字段(定义于下一首部字段中)设为41指示该IPv4有效载荷是IPv6数据报)，从中取出IPv6数据报，然后再为该IPv6数据报提供路由

### ICMP

**因特网控制报文协议ICMP**用于主机、路由器、网关传达网络层控制信息

ICMP通常被认为是IP的一部分，但ICMP报文作为IP有效载荷承载

ICMP报文包含
- 一个类型字段
- 一个编码字段
- 引起该ICMP报文首次生成的IP数据报的首部和前8个字节

[ICMP报文类型](https://zh.wikipedia.org/zh-cn/互联网控制消息协议#报文类型)

## 路由器

网络层的主要功能依托于路由器实现
路由器包含四个组件：输入端口、交换结构、输出端口、路由选择处理器
其中输入端口、输出端口和交换结构(执行数据平面转发功能)几乎总是用硬件实现，因此得以实现远快于软件处理的速度，以纳秒时间尺度运行
控制平面路由选择功能用软件实现并在路由选择处理器上执行，通常以毫秒或秒时间尺度运行，

**输入端口**在物理层实现bit级的接收，在数据链路层实现链路层协议动作、解封装，然后根据转发表决定路由器的输出端口，进入输入缓存排队等待交换机构转发

**交换结构**通常使用的交换技术有三种
- *经内存交换* - 分组被复制到内存后再次复制到输出端口缓存
	- 早期路由选择处理器直接控制完成
	- 现代通过输入线路卡处理
- *经总线交换* - 分组通过一根共享总线从输入端口转发到输出端口，一次处理一个分组
- *经互联网络交换* - 同时并发转发多个分组，克服总线带宽限制

**输出端口**缓存从交换机构到来的数据报，由调度规则选择排队的数据报进行传输
调度规则：
- FIFO(first in first out) - 先来先发
- 优先权 - 发送高优先权的分组
- Round Robin (RR) - 按类循环发送，每次每类单个
- Weighted Fair Queuing (WFQ) - 每个类在每一个循环中获得不同权重的服务量

**路由选择处理器**执行控制平面功能
在传统路由器中，它执行路由选择协议，维护路由选择表与关联链路状态信息，并为该路由器计算转发表。
在SDN路由器中，路由选择处理器(在其他活动中)负责与远程控制器通信，接收由远程控制器计算的转发表项，并在该路由器的输入端口安装这些表项

路由的转发表包含**目标子网号**，**子网掩码**，**下一跳地址**以及**接口**四个元素，将目标IP依次与转发表中的表项匹配，如果目标ip地址&子网掩码 = 目标子网号，则按照对应接口转发数据报，若都不匹配则使用默认表项转发数据报
当给定目标地址查找转发表时，采用**最长前缀匹配**(longest prefix matching)的目标地址表项

## 路由选择算法

**路由选择算法**(routing algorithm)是网络层软件的一部分，完成路由(确定分组从源到目标的路径)功能
路由选择算法实际以网络而非主机为单位进行路由，子网中路由器-主机之间的通信不需要路由选择算法解决
路由选择算法需具有正确性，简单性，健壮性，稳定性，公平性以及最优性

路由选择算法的分类方式一：
集中式路由选择算法用完整的、全局性的网络知识计算，从源到目的地之间的最低开销路径，
分散式路由选择算法中路由器以迭代、分布式的方式计算出最低开销路径

分类方式二；
静态路由选择/非自适应算法，路由随时间的变化非常缓慢，通常是人为进行调整(如人为手工编辑一条链路开销)
动态路由选择/自适应算法随着网络流量负载或拓扑发生变化而改变路由选择路径。

### 链路状态路由选择LS

具有全局状态信息的算法常被称作**链路状态**(Link State, **LS**)算法
1. 发现相邻节点,获知对方网络地址
2. 测量到相邻节点的代价(延迟,开销)
3. 组装一个LS分组,描述它到相邻节点的代价情况
4. 将分组通过泛洪发到所有其它路由器
	以上4步让每个路由器获得拓扑和边代价
5. 通过**Dijkstra算法**找出最短路径(真正的路由算法)

泛洪过程中使用**顺序号**字段控制无穷的扩散,每个路由器都记录收到LS分组中的(源路由器X,顺序号)，收到包含(源路由器X,现有/更早顺序号)的LS分组则丢弃，同时使用**年龄**字段定期删除路由器中保存的LS信息

此外LS算法的运行可能引起网络中传输的振荡，一种解决方法为让每台路由器发送LS分组的时间随机化

应用LS算法的协议包括OSPF协议和IS-IS协议

### 距离矢量路由选择DV

**距离向量**(Distance-Vector, **DV**)算法是分散式路由选择算法的一种，使用**Bellman-Ford 方程**进行动态规划

对于节点A：
- 根据实测得到本节点A到相邻站点的代价
- 根据各相邻站点声称它们到目标站点B的代价计算出本站点A经过各相邻站点到目标站点B的代价
- 找到一个最小的代价和相应的下一个节点Z，经过此节点Z到达节点B，并且代价为A-Z-B的代价
- 定期测量A到相邻节点的代价，到任何目标的DV发生变化时通告邻居
- 收到邻居的DV更新时重新计算代价估计值，到任何目标的DV发生变化时通告邻居

DV存在无穷计算问题
*例*：x-y-z
节点x突然不可达时会导致**路由选择环路**(routing loop)
即为到达x, y通过z路由，z又通过y路由，需经过多次反复更新得y-x之间的代价为无穷

*一种解决方法*：水平分裂/毒性逆转
z知道要经过y才能到达x，所以z向y报告z-x=Inf，向其他邻居广播z-x的真实代价
在存在环路时无穷计算问题依然存在
![|300](https://image.jiang849725768.asia/2022/202212302157944.png)

DV消息复杂度低，LS收敛时间短且健壮性强，在互联网中二者都有应用

## 路由自治系统AS

在所有路由器之间计算路由开销巨大，且ISP通常希望自行管理路由器，因此实际情况中采取**层次路由**，路由器被组织为**自治系统**(Autonomous System, **AS**)
每个AS由一组通常处在相同管理控制下的路由器组成，通常ISP将其中的路由器以及互联它们的链路构成一个或多个AS
一个AS由ICANN区域注册机构所分配的全局唯一的AS号(ASN) 所标识

在一个AS内运行的路由选择算法叫作**自治系统内部路由选择协议**，包括RIP和OSPF
互联网中所有AS运行相同的AS间路由协议 - **边界网关协议**(Broder Gateway Protocol, **BGP**)

### 自治系统内部路由选择协议

#### RIP(Routing Information Protocol)

基于DV算法
- 距离矢量:每条链路cost=1，# of hops (max = 15 hops) 跳数
- 节点每隔30秒和邻居交换DV
- 每个通告包括AS内部的最多25个目标子网
- 180秒没有收到通告信息表示邻居或者链路失效

#### OSPF(Open Shortest Path First)

基于LS算法
LS分组在AS内部网络中分发，通告信息中携带到达每个邻居的代价
在IP数据报上直接传送OSPF报文

高级特性：
 - 所有的OSPF报文都经过认证以保证安全
 - 允许有多个代价相同的路径存在
 - 每一个链路对于不同的服务有多重代价矩阵，支持按照不同的代价计算最优路径
 - 对单播和多播的集成支持
 - 在大型网络中支持层次性OSPF,分为本地和骨干区域
![|450](https://image.jiang849725768.asia/2022/202212302233249.png)

### 自治区域间路由协议BGP

在BGP中，每对路由器通过使用179端口的半永久TCP连接交换路由选择信息，AS使用**网关路由器**(位于AS边缘的路由器)与其他AS相连接
BGP基于距离矢量算法运行，但在每个节点维护到达各个目标网络的详细路径以解决无穷计算问题

BGP功能：
- 相邻的AS通过外部BGP(**eBGP**)获得其他AS中子网的可达信息
- 相同AS中的路由器间通过内部BGP(**iBGP**)传递网关路由器获得的子网可达信息
- 根据子网可达信息和策略来决定到达子网的“好”路径

当路由器通过BGP连接通告子网前缀时，通告包括BGP属性(BGP术语中子网前缀及其属性称为路由)，两个重要的BGP属性为**AS-PATH**和**NEXT-HOP**
- **AS-PATH**：前缀通告所经过的AS列表
- **NEXT-HOP**：从当前AS到下一跳AS的多个链路中所选择的下一个网关路由器的输入接口的IP地址

当一个网关路由器接收到了一个路由通告, 其使用**输入策略**来接受或过滤该通告，同时也决定是否向其它邻居通告收到的这个路由信息
获得关于同一个子网X的多个路径时，其通过**路由选择算法**选择路径并通过iBGP通告给所有AS内部的路由器
路由器结合 *eBGP决定的AS到X的路径* 以及 *iBGP(例如OSPF)决定的相应网关路由器与输出接口* 得到目标子网与自身输出接口的对应转发表项

**热土豆路由选择**是路由选择算法之一，该算法下路由器选择使得通往NEXT-HOP的路径的开销最小(具备最小内部区域代价)的网关路由器作为往X的出口

## SDN与通用转发

传统方式下控制平面由每个路由器上的实现路由算法的元件*分布式*实现(它们之间需要相互交互)
缺点为设备的功能固化，类似防火墙、NAT、负载均衡等功能都得使用特定设备实现，升级和管理困难

**软件定义网络**(software-defined networking，SDN)
- 将网络设备数据平面和控制平面分离
- 将路由器、交换机和目前大多数网络设备的功能进一步抽象成：按照**流表**(由控制平面设置的控制逻辑)进行**协议数据单元PDU**(帧、分组)的**动作**(包括转发、丢弃、拷贝、泛洪、阻塞)
- 将设备统一为**SDN交换机(分组交换机)**，执行控制逻辑

**流表**为位于每台分组交换机中的一张匹配加动作表，该表由SDN控制器自动计算、安装和更新
**分组交换机**按照流表对接收的数据包根据匹配进行动作
**SDN控制器**通过**北向API**和网络控制应用交互，基于**南向API**访问分组交换机，与本地控制代理CA交互，将计算得出的流表安装至分组交换机
**网络控制应用**采用下层提供的服务(SDN控制器提供的API)实现网络功能

**OpenFlow协议**是控制器和分组交换机交互的协议，其将数据平面抽象为由头部字段所定义的**流**以及包含简单的分组处理规则的**通用转发**
**通用转发**包括将分组头部字段和流表进行匹配的**模式**，对于匹配的分组采取的丢弃、转发、修改等**行动**，匹配多个模式时的**优先权**以及**计数器**

部分OpenFlow中关键的控制器到交换机的报文
- 特性：控制器查询交换机特性，交换机应答
- 配置：交换机查询/设置交换机的配置参数
- 修改状态：增加删除修改OpenFlow表中的流表
- packet-out：控制器可以将分组通过特定的端口发出
- 分组进入: 将分组(和它的控制)传给控制器
- 流移除: 在交换机上删除流表项
- 端口状态: 通告控制器端口的变化

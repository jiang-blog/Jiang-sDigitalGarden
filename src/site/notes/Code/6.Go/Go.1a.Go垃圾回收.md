---
{"dg-publish":true,"permalink":"/Code/6.Go/Go.1a.Go垃圾回收/","title":"Go垃圾回收","noteIcon":""}
---


# Go垃圾回收

> [5、Golang三色标记混合写屏障GC模式全分析 (yuque.com)](https://www.yuque.com/aceld/golang/zhzanb)
> [垃圾回收的认识 | Go 程序员面试笔试宝典 (golang.design)](https://golang.design/go-questions/memgc/principal/)
> [Go 语言垃圾收集器的实现原理 | Go 语言设计与实现 (draveness.me)](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-garbage-collector/)

Go 的 GC 目前使用的是**无分代**(对象没有代际之分)、**不整理**(回收过程中不对对象进行移动与整理)、**并发**(与用户代码并发执行)的三色标记清扫算法

**只要一个变量还能被访问，它就不会被回收**

Go 的编译器会通过[[Code/6.Go/Go.1c.Go内存管理#逃逸分析\|逃逸分析]]将大部分新生对象存储在栈上(栈直接被回收)，只有那些需要长期存在的对象才会被分配到需要进行垃圾回收的堆中

当前流程：
| 阶段             | 说明                                                       | 赋值器状态 |
| ---------------- | ---------------------------------------------------------- | ---------- |
| SweepTermination | 清扫终止阶段，为下一个阶段的并发标记做准备工作，启动写屏障 | STW        |
| Mark             | 扫描标记阶段，与赋值器并发执行，写屏障开启                 | 并发       |
| MarkTermination  | 标记终止阶段，保证一个周期内标记任务完成，停止写屏障       | STW        |
| GCoff            | 内存清扫阶段，将需要回收的内存归还到堆中，写屏障关闭       | 并发       |
| GCoff            | 内存归还阶段，将过多的内存归还给操作系统，写屏障关闭       | 并发       |

## GC 简介

> [垃圾回收的认识 | Go 程序员面试笔试宝典 (golang.design)](https://golang.design/go-questions/memgc/principal/)

`GC`是一种自动内存管理的机制

当程序向操作系统申请的内存不再需要时，垃圾回收主动将其回收并供其他代码进行内存申请时候复用，或者将其归还给操作系统
这种针对内存级别资源的自动回收过程即为垃圾回收，负责垃圾回收的程序组件即为垃圾回收器

通常，垃圾回收器的执行过程被划分为两个半独立的组件：
- 赋值器：这一名称本质上是在指代用户态的代码，对垃圾回收器而言，用户态的代码仅仅只是在修改对象之间的引用关系，也就是在对象图(对象之间引用关系的一个有向图)上进行操作
- 回收器：负责执行垃圾回收的代码

### 根对象

根对象又称为根集合，是垃圾回收器在标记过程时最先检查的对象，包括：
- 全局变量：程序在编译期就能确定的那些存在于程序整个生命周期的变量
- 执行栈：每个 goroutine 都包含自己的执行栈，这些执行栈上包含栈上的变量及指向分配的堆内存区块的指针
- 寄存器：寄存器的值可能表示一个指针，参与计算的这些指针可能指向某些赋值器分配的堆内存区块

### GC 方式

GC 算法可以归结为追踪和引用计数两种形式的混合运用
- 追踪式 GC
  - 从根对象出发，根据对象之间的引用信息，一步步推进直到扫描完毕整个堆并确定需要保留的对象，从而回收所有可回收的对象
  - Go、 Java、V8 对 JavaScript 的实现等均为追踪式 GC
- 引用计数式 GC
  - 每个对象自身包含一个被引用的计数器，当计数器归零时自动得到回收。因为此方法缺陷较多，在追求高性能时通常不被应用
  - Python、Objective-C 等均为引用计数式 GC

## 三色标记

### V1.3 标记清除算法

- 标记阶段：暂停程序(STW)，从根节点的对象集合出发，查找并标记堆中所有存活的可达对象
- 清除阶段：遍历堆中所有的对象，回收未被标记的不可达对象，并将对应的内存加入空闲链表中

<?xml version="1.0" encoding="UTF-8"?>
<!-- Do not edit this file with editors other than diagrams.net -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="421px" height="281px" viewBox="-0.5 -0.5 421 281" content="&lt;mxfile host=&quot;app.diagrams.net&quot; modified=&quot;2023-03-09T03:03:51.522Z&quot; agent=&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36 Edg/111.0.0.0&quot; etag=&quot;ARBytcuZ8lhFYJFTltZf&quot; version=&quot;21.0.2&quot; type=&quot;onedrive&quot;&gt;&lt;diagram name=&quot;第 1 页&quot; id=&quot;DSCh09o9TDqoaF7elWF5&quot;&gt;1VjbbqMwEP0aHruKMbc8trm0D92XzSqbPlrgAJHByHEa6NevARMgTnORUplEisSMLxmf4zlDxoCTJH9lKIt+0wATwxyFLA4MODVME4ivcGQoxD1HOWMRfzXOkfTu4gBvexM5pYTHWd/p0zTFPu/5EGN035+2pkQNY+EjghXvvzjgUe31TLf1v+E4jJofAs64HklQM1kGvo1QQPcdF5wZcMIo5fVTkk8wKZFpcKnXzb8ZPQTGcMqvWbBZjjbP/nLqPa3+4uXb1/tykzzJXT4R2ckDy2B50SDA6C4NcLnJyIAv+yjmeJEhvxzdC0KFL+IJERYQj3I7zDjOv40THE4v7gSmCeasEFOaBQ1gRW0fmN+3+FvNnKiDvelJJ5IUh4e9W1jEg0TmFpQsBRUciGsiTcp4REOaIjJrvS993No575RmEq0N5ryQVxztOO1jifOYrzrPH+VWv2xpTXO5c2UU0qjjLIM7j744C90xH585tLwJHLEQ8zPz3NNsMkwQjz/7cdyfGVsnMy0bH10yTjIj8GfFqmt0+CzNdlllaWQU6mTUVBTp+YwkgcuStKYpl0wCT9oTSiir9oLz6lP6Y0I6/lH1uY+kmXZf0iBUJc0+oWj2TwkaVEB+fXiQoXdUNyzNIFsKyC8PD/LxTT4UYl0gA2c4BQBcVwCAtgJgX1kAHJ0FwFbSZnLftLlDGljOwAQduFrT4IY31AGkgXNlGlg608BR0mA6uDSAjjWsauAqoM0evuRCd2Ba4ykgzwd3M48FWvvLIAAKRgNtIQzgj2rT8bmo0KZOhQZqr2zor54PQKnWottE2dG2P2WDVuGZkDjb4svShrZZ3YRex3nJulpQ+oVjPJ7Px+M7NVLhUeE4UZ3dExro3q6Bwmwb2dVYp9cPZ/8B&lt;/diagram&gt;&lt;/mxfile&gt;" resource="https://app.diagrams.net/#Wed16f148a30900a%2FED16F148A30900A!61298"><defs/><g><rect x="0" y="0" width="420" height="280" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><path d="M 180 145 L 243.63 145" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 248.88 145 L 241.88 148.5 L 243.63 145 L 241.88 141.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><path d="M 155 120 L 155 55 L 253.63 55" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 258.88 55 L 251.88 58.5 L 253.63 55 L 251.88 51.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="130" y="120" width="50" height="50" rx="7.5" ry="7.5" fill="#000000" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 48px; height: 1px; padding-top: 145px; margin-left: 131px;"><div data-drawio-colors="color: #FFFFFF; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(255, 255, 255); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">A</div></div></div></foreignObject><text x="155" y="150" fill="#FFFFFF" font-family="Helvetica" font-size="18px" text-anchor="middle">A</text></switch></g><rect x="260" y="30" width="50" height="50" rx="7.5" ry="7.5" fill="#000000" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 48px; height: 1px; padding-top: 55px; margin-left: 261px;"><div data-drawio-colors="color: #FFFFFF; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(255, 255, 255); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">G</div></div></div></foreignObject><text x="285" y="60" fill="#FFFFFF" font-family="Helvetica" font-size="18px" text-anchor="middle">G</text></switch></g><rect x="130" y="210" width="50" height="50" rx="7.5" ry="7.5" fill="#000000" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 48px; height: 1px; padding-top: 235px; margin-left: 131px;"><div data-drawio-colors="color: #FFFFFF; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(255, 255, 255); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">B</div></div></div></foreignObject><text x="155" y="240" fill="#FFFFFF" font-family="Helvetica" font-size="18px" text-anchor="middle">B</text></switch></g><path d="M 365 170 L 365 235 L 300.37 235" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 295.12 235 L 302.12 231.5 L 300.37 235 L 302.12 238.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="340" y="120" width="50" height="50" rx="7.5" ry="7.5" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 48px; height: 1px; padding-top: 145px; margin-left: 341px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">C</div></div></div></foreignObject><text x="365" y="150" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="18px" text-anchor="middle">C</text></switch></g><path d="M 244 235 L 186.37 235" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 181.12 235 L 188.12 231.5 L 186.37 235 L 188.12 238.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="244" y="210" width="50" height="50" rx="7.5" ry="7.5" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 48px; height: 1px; padding-top: 235px; margin-left: 245px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">D</div></div></div></foreignObject><text x="269" y="240" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="18px" text-anchor="middle">D</text></switch></g><rect x="250" y="120" width="50" height="50" rx="7.5" ry="7.5" fill="#000000" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 48px; height: 1px; padding-top: 145px; margin-left: 251px;"><div data-drawio-colors="color: #FFFFFF; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(255, 255, 255); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">E</div></div></div></foreignObject><text x="275" y="150" fill="#FFFFFF" font-family="Helvetica" font-size="18px" text-anchor="middle">E</text></switch></g><rect x="340" y="30" width="50" height="50" rx="7.5" ry="7.5" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 48px; height: 1px; padding-top: 55px; margin-left: 341px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">F</div></div></div></foreignObject><text x="365" y="60" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="18px" text-anchor="middle">F</text></switch></g><path d="M 80 145 L 123.63 145" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 128.88 145 L 121.88 148.5 L 123.63 145 L 121.88 141.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><path d="M 45 180 L 45 235 L 123.63 235" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 128.88 235 L 121.88 238.5 L 123.63 235 L 121.88 231.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><ellipse cx="45" cy="145" rx="35" ry="35" fill="#99ff99" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 68px; height: 1px; padding-top: 145px; margin-left: 11px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">Root</div></div></div></foreignObject><text x="45" y="150" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="18px" text-anchor="middle">Root</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>

**问题**：
- STW(Stope The World)严重影响性能
- 清除数据产生堆内存碎片

> [!note] 根集合
> **全局变量**：程序在编译期就能确定的那些存在于程序整个生命周期的变量
>  **执行栈**：每个 Goroutine 都包含自己的执行栈，执行栈上包含栈上变量及指向堆内存的指针
>  **寄存器**：寄存器的值可能表示一个指针，参与计算的这些指针可能指向堆内存

### V1.5 三色标记法

三色标记算法将程序中的对象分为白色、灰色和黑色三类：
- **白色**：潜在垃圾，未被回收器访问到的对象，在回收开始阶段，所有对象都被标记为白色；回收结束后，白色对象均不可达，释放相应内存
- **灰色**：活跃对象，已被回收器访问到，但存在指向白色对象的外部指针，垃圾收集器需要继续扫描其子对象
- **黑色**：活跃对象，已被垃圾收集器访问到，其所有字段都已被扫描

**三色标记法步骤**：
1. 应用程序开始运行时，所有对象默认标记为白色
2. 每次GC时从根节点遍历对象，将对象标记为灰色
3. 对灰色对象集合中每个灰色对象，遍历其引用对象，将其引用的白色对象标记为灰色，之后将该灰色对象标记为黑色
4. 重复遍历灰色对象集合直到集合为空，所有可达对象已标记为黑
5. 回收仍为白色的不可达对象

不执行STW时，**同时出现下面两个情况会破坏GC的正确性**：
- 某个黑色对象引用白色对象
- 还未遍历到的灰色对象对白色对象的引用受到破坏

因此让 GC 满足以下两种情况之一，就能够保证正确性：
- **强三色不变性**
不允许黑色对象引用白色对象的情况出现
- **弱三色不变性**
允许黑色对象引用白色对象，但该白色对象必须同时可由另一个灰色对象通过若干其他白色对象到达

## 屏障机制

> [再谈 Golang 垃圾回收 – 兰陵美酒郁金香的个人博客 (xhyonline.com)](https://www.xhyonline.com/?p=1185)

对象在内存槽中有两种位置：栈和堆，栈空间的特点是容量小，但要求响应速度快，所以Go语言中**写屏障机制仅在堆空间上启用**

### V1.7 Dijkstra插入写屏障

操作：在对象A引用对象B的时候，将对象B标记为灰色，**可满足强三色不变性**

由于不对栈空间进行插入写屏障，因此在完成扫描后需要启用 STW 对栈重新进行三色标记扫描

**问题**：减少了STW的时间，但仍然存在

### Yuasa删除写屏障

操作：删除对于对象B的引用时，如果对象B为白色，将其标记为灰色，**可满足弱三色不变性**

**问题**：回收精度低，一次 GC 中一个对象即使被删除了最后一个引用也依旧可以存活，在下一轮 GC 中被清理掉

插入写屏障和删除写屏障的短板：
- 插入写屏障：结束时需要STW来重新扫描栈，标记栈上引用的白色对象的存活
- 删除写屏障：回收精度低，GC开始时STW扫描堆栈来记录初始快照，这个过程会保护开始时刻的所有存活对象

### V1.8 混合写屏障机制

操作：
- 对于栈，开始时扫描栈对象并将可达对象全部标记为黑色，GC 期间栈上创建的新对象均为黑色
- 对于堆，同时使用删除写屏障和插入写屏障，堆上被删除和被添加的对象标记为灰色

**可满足弱三色不变性**，不需要STW

### V1.9

彻底移除了栈的重扫描过程，**GC仅用于堆空间**

> 垃圾回收只会回收堆上的对象，但是为什么需要栈空间呢？因为栈上存在着根节点，堆上对象是通过根节点扫描到的，思考一下，我们在程序中一般创建对象，假设创建在堆上，然后我们在函数内去操作这个对象，这里我们是通过在函数中的局部变量去操作这个堆上的对象的，所以这种情况下堆上对象一定是和局部变量相关联的，局部变量是保存在栈上的，所以要找到所有堆中可达对象，栈上的对象可以作为根节点全部扫描一遍

### V1.14

> ![gc-process.png (516×349) (golang.design)](https://golang.design/go-questions/memgc/assets/gc-process.png)

### 其他

**Go 的 GC 有分栈空间清扫与堆空间清扫**

> 每个调度器的结构体有两个 G，一个是 crug，代表结构体 M 当前绑定的结构体 G。另一个是 g0，是带有调度栈的 goroutine，这是一个比较特殊的 goroutine
> 注意： 普通的 goroutine 的栈是在堆上分配的可增长的栈，而 g0的栈是 M 对应的线程的栈，所有调度相关的代码，会先切换到该 goroutine 栈中再执行，也就是说线程的栈也是用的 g 实现，而不是使用 os 的
> **g0所使用的栈就是Go程序进程所创建的M线程的线程栈，与相关的task_struck相关联**而未与M绑定(不是running状态的goroutine)的goroutine的协程栈也是存放在进程的堆空间中的

## 内存泄漏

Go语言中仍可能发生内存泄漏：预期的能很快被释放的内存由于附着在了长期存活的内存上、或生命期意外地被延长，导致预计能够立即回收的内存长时间得不到回收。

1. 预期能被快速释放的内存因被根对象引用而没有得到迅速的释放
e.g. 当有一个全局对象时，可能不经意间将某个变量附着在其上，且忽略释放该变量，则其内存永远不会得到释放
2. Goroutine泄漏
Goroutine在运行过程中消耗的用于维护上下文信息的内存不会被释放，当一个程序持续不断地产生新的Goroutine、且不结束已创建的Goroutine并复用这部分内存，就会造成内存泄露
3. Channel 泄漏
如果一个 goroutine 阻塞在 channel 处而 channel 数据一直未改变，则该 goroutine 会被动永久休眠，整个 goroutine 及其执行栈都得不到释放

## GC触发

>[垃圾回收机制的实现 | Go 程序员面试笔试宝典 (golang.design)](https://golang.design/go-questions/memgc/impl/)

Go 语言中对 GC 的触发时机存在两种形式：
- *主动触发*，通过调用 `runtime.GC` 来触发 GC，此调用阻塞式地等待当前 GC 运行完毕
- *被动触发*，分为两种方式：
    - 使用步调(Pacing)算法，其核心思想是控制内存增长的比例，默认配置会**在堆内存达到上一次垃圾收集的 2 倍时**，触发新一轮的垃圾收集
    - 使用系统监控，当**超过两分钟没有产生任何 GC 时**，强制触发 GC
    - **当前线程的内存管理单元中不存在空闲空间时**，创建微对象和小对象需要从MCentral或者MHeap中获取新的管理单元，在这时就可能触发垃圾收集
    - 当**用户程序申请分配 32KB 以上的大对象时**，一定会尝试触发垃圾收集

>目前的 Go 实现中，当 GC 触发后，会首先进入并发标记的阶段。并发标记会设置一个标志，并在 mallocgc 调用时进行检查。当存在新的内存分配时，会**暂停分配内存过快的那些 goroutine**，并将其转去执行一些辅助标记(Mark Assist)的工作，从而达到放缓继续分配、辅助 GC 的标记工作的目的。
>具体操作为编译器分析用户代码，并在需要分配内存的位置，将申请内存的操作翻译为 `mallocgc` 调用，而 `mallocgc` 的实现决定了标记辅助的实现，伪代码思路如下：
```go
func mallocgc(t typ.Type, size uint64) {
	if enableMarkAssist {
		// 进行标记辅助，此时用户代码没有得到执行
		(...)
	}
	// 执行内存分配
	(...)
}
```

## GC 调优

[垃圾回收的优化问题 | Go 程序员面试笔试宝典 (golang.design)](https://golang.design/go-questions/memgc/optimize/#14-go-%e7%9a%84-gc-%e5%a6%82%e4%bd%95%e8%b0%83%e4%bc%98)

当我们谈论 GC 调优时，通常是指减少用户代码对 GC 产生的压力
一方面包含了减少用户代码分配内存的数量(即对程序的代码行为进行调优)
另一方面包含了最小化 Go 的 GC 对 CPU 的使用率（即调整 GOGC)

### 合理化内存分配的速度、提高赋值器的 CPU 利用率

### 降低并复用已经申请的内存

### 调整 GOGC
